# Stage 4: Help File Generator

## Objective

Rewrite the help file generator to produce the new format with:
- Project-local binary installation via `go install`
- `GOBIN ?= .bin` with conditional assignment
- `.PHONY: help` and all `help-<target>` targets
- Version pinning support via `--version`

## Files to Modify

### 1. `internal/target/generator.go`

**Rewrite `generateHelpTarget()` to `GenerateHelpFile()`:**

```go
package target

import (
    "fmt"
    "strings"
)

// GeneratorConfig holds configuration for help file generation.
type GeneratorConfig struct {
    // Options to embed in MAKE_HELP_OPTS
    KeepOrderCategories bool
    KeepOrderTargets    bool
    CategoryOrder       []string
    DefaultCategory     string
    IncludeTargets      []string
    IncludeAllPhony     bool

    // Version for go install (empty = @latest)
    Version string
}

// GenerateHelpFile creates the complete help Makefile content.
// targets is the list of documented target names for help-<target> generation.
func GenerateHelpFile(config *GeneratorConfig, targets []string) string {
    var buf strings.Builder

    // Header
    buf.WriteString("# Generated by make-help. DO NOT EDIT.\n")
    buf.WriteString(fmt.Sprintf("# Regenerate with: make-help --create-help-target%s\n",
        buildRegenerateFlags(config)))
    buf.WriteString("\n")

    // Variables
    buf.WriteString("GOBIN ?= .bin\n")
    buf.WriteString("MAKE_HELP_BIN := $(GOBIN)/make-help\n")
    buf.WriteString(fmt.Sprintf("MAKE_HELP_OPTS := %s\n", buildMakeHelpOpts(config)))
    buf.WriteString("MAKE_HELP_CMD := $(MAKE_HELP_BIN) $(MAKE_HELP_OPTS)\n")
    buf.WriteString("\n")

    // Binary install target (NOT .PHONY - only rebuilds if binary missing)
    version := "@latest"
    if config.Version != "" {
        version = "@" + config.Version
    }
    buf.WriteString("$(MAKE_HELP_BIN):\n")
    buf.WriteString(fmt.Sprintf("\tGOBIN=$(abspath $(GOBIN)) go install github.com/sdlcforge/make-help/cmd/make-help%s\n", version))
    buf.WriteString("\n")

    // Main help target
    buf.WriteString(".PHONY: help\n")
    buf.WriteString("## Displays help summary.\n")
    buf.WriteString("help: $(MAKE_HELP_BIN)\n")
    buf.WriteString("\t@$(MAKE_HELP_CMD)\n")
    buf.WriteString("\n")

    // help-<target> for each documented target
    for _, target := range targets {
        buf.WriteString(fmt.Sprintf(".PHONY: help-%s\n", target))
        buf.WriteString(fmt.Sprintf("help-%s: $(MAKE_HELP_BIN)\n", target))
        buf.WriteString(fmt.Sprintf("\t@$(MAKE_HELP_CMD) --target %s\n", target))
        buf.WriteString("\n")
    }

    return buf.String()
}

// buildMakeHelpOpts builds the MAKE_HELP_OPTS string from config.
func buildMakeHelpOpts(config *GeneratorConfig) string {
    var opts []string

    if config.KeepOrderCategories {
        opts = append(opts, "--keep-order-categories")
    }
    if config.KeepOrderTargets {
        opts = append(opts, "--keep-order-targets")
    }
    if len(config.CategoryOrder) > 0 {
        opts = append(opts, fmt.Sprintf("--category-order %s", strings.Join(config.CategoryOrder, ",")))
    }
    if config.DefaultCategory != "" {
        opts = append(opts, fmt.Sprintf("--default-category %s", config.DefaultCategory))
    }
    if len(config.IncludeTargets) > 0 {
        opts = append(opts, fmt.Sprintf("--include-target %s", strings.Join(config.IncludeTargets, ",")))
    }
    if config.IncludeAllPhony {
        opts = append(opts, "--include-all-phony")
    }

    if len(opts) == 0 {
        return ""
    }
    return strings.Join(opts, " ")
}

// buildRegenerateFlags builds the flag string for the regeneration comment.
func buildRegenerateFlags(config *GeneratorConfig) string {
    // Similar to buildMakeHelpOpts but includes --version if set
    var flags []string

    if config.Version != "" {
        flags = append(flags, fmt.Sprintf(" --version %s", config.Version))
    }

    // Add same flags as MAKE_HELP_OPTS
    opts := buildMakeHelpOpts(config)
    if opts != "" {
        flags = append(flags, " "+opts)
    }

    return strings.Join(flags, "")
}
```

### 2. `internal/target/config.go` (new file or update existing)

If `Config` struct in `add.go` is used elsewhere, consider moving `GeneratorConfig` here for clarity.

## Generated Output Example

For a project with documented targets `build`, `test`, `clean`:

```makefile
# Generated by make-help. DO NOT EDIT.
# Regenerate with: make-help --create-help-target --default-category Misc

GOBIN ?= .bin
MAKE_HELP_BIN := $(GOBIN)/make-help
MAKE_HELP_OPTS := --default-category Misc
MAKE_HELP_CMD := $(MAKE_HELP_BIN) $(MAKE_HELP_OPTS)

$(MAKE_HELP_BIN):
	GOBIN=$(abspath $(GOBIN)) go install github.com/sdlcforge/make-help/cmd/make-help@latest

.PHONY: help
## Displays help summary.
help: $(MAKE_HELP_BIN)
	@$(MAKE_HELP_CMD)

.PHONY: help-build
help-build: $(MAKE_HELP_BIN)
	@$(MAKE_HELP_CMD) --target build

.PHONY: help-test
help-test: $(MAKE_HELP_BIN)
	@$(MAKE_HELP_CMD) --target test

.PHONY: help-clean
help-clean: $(MAKE_HELP_BIN)
	@$(MAKE_HELP_CMD) --target clean
```

With `--version v1.2.3`:

```makefile
# Regenerate with: make-help --create-help-target --version v1.2.3
...
$(MAKE_HELP_BIN):
	GOBIN=$(abspath $(GOBIN)) go install github.com/sdlcforge/make-help/cmd/make-help@v1.2.3
```

## Acceptance Criteria

- [ ] Generated file includes `GOBIN ?= .bin` (conditional assignment)
- [ ] Generated file includes binary install target with `go install`
- [ ] Binary target is NOT `.PHONY` (only rebuilds if binary missing)
- [ ] `help` target is `.PHONY` and depends on binary
- [ ] All `help-<target>` targets are `.PHONY`
- [ ] `--version` flag sets version in `go install` command
- [ ] Empty `--version` uses `@latest`
- [ ] Header comment includes regeneration command with all flags
- [ ] `MAKE_HELP_OPTS` includes all relevant flags
- [ ] Generated Makefile has correct syntax (passes `make -n`)

## New Tests

### `internal/target/generator_test.go`
```go
func TestGenerateHelpFile_Basic(t *testing.T) {
    // Test basic generation with no options
}

func TestGenerateHelpFile_WithVersion(t *testing.T) {
    // Test --version flag generates correct go install
}

func TestGenerateHelpFile_WithAllOptions(t *testing.T) {
    // Test all config options are passed through
}

func TestGenerateHelpFile_MultipleTargets(t *testing.T) {
    // Test help-<target> generation for multiple targets
}

func TestGenerateHelpFile_ValidMakefile(t *testing.T) {
    // Write to temp file, run make -n to validate syntax
}

func TestBuildMakeHelpOpts(t *testing.T) {
    // Test MAKE_HELP_OPTS string building
}
```

### `test/fixtures/expected/generated_help.mk` (new fixture)
Expected output for integration testing.
