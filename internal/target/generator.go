package target

import (
	"fmt"
	"strings"
)

// GeneratorConfig holds configuration for help file generation.
type GeneratorConfig struct {
	// Options to embed in MAKE_HELP_OPTS
	KeepOrderCategories bool
	KeepOrderTargets    bool
	CategoryOrder       []string
	DefaultCategory     string
	IncludeTargets      []string
	IncludeAllPhony     bool

	// Version for go install (empty = @latest)
	Version string
}

// GenerateHelpFile creates the complete help Makefile content.
// targets is the list of documented target names for help-<target> generation.
func GenerateHelpFile(config *GeneratorConfig, targets []string) string {
	var buf strings.Builder

	// Header
	buf.WriteString("# Generated by make-help. DO NOT EDIT.\n")
	buf.WriteString(fmt.Sprintf("# Regenerate with: make-help --create-help-target%s\n",
		buildRegenerateFlags(config)))
	buf.WriteString("\n")

	// Variables
	buf.WriteString("GOBIN ?= .bin\n")
	buf.WriteString("MAKE_HELP_BIN := $(GOBIN)/make-help\n")
	makeHelpOpts := buildMakeHelpOpts(config)
	if makeHelpOpts != "" {
		buf.WriteString(fmt.Sprintf("MAKE_HELP_OPTS := %s\n", makeHelpOpts))
	} else {
		buf.WriteString("MAKE_HELP_OPTS :=\n")
	}
	buf.WriteString("MAKE_HELP_CMD := $(MAKE_HELP_BIN) $(MAKE_HELP_OPTS)\n")
	buf.WriteString("\n")

	// Binary install target (NOT .PHONY - only rebuilds if binary missing)
	version := "@latest"
	if config.Version != "" {
		version = "@" + config.Version
	}
	buf.WriteString("$(MAKE_HELP_BIN):\n")
	buf.WriteString(fmt.Sprintf("\tGOBIN=$(abspath $(GOBIN)) go install github.com/sdlcforge/make-help/cmd/make-help%s\n", version))
	buf.WriteString("\n")

	// Main help target
	buf.WriteString(".PHONY: help\n")
	buf.WriteString("## Displays help summary.\n")
	buf.WriteString("help: $(MAKE_HELP_BIN)\n")
	buf.WriteString("\t@$(MAKE_HELP_CMD)\n")

	// help-<target> for each documented target
	for _, target := range targets {
		buf.WriteString("\n")
		buf.WriteString(fmt.Sprintf(".PHONY: help-%s\n", target))
		buf.WriteString(fmt.Sprintf("help-%s: $(MAKE_HELP_BIN)\n", target))
		buf.WriteString(fmt.Sprintf("\t@$(MAKE_HELP_CMD) --target %s\n", target))
	}

	return buf.String()
}

// buildMakeHelpOpts builds the MAKE_HELP_OPTS string from config.
func buildMakeHelpOpts(config *GeneratorConfig) string {
	var opts []string

	if config.KeepOrderCategories {
		opts = append(opts, "--keep-order-categories")
	}
	if config.KeepOrderTargets {
		opts = append(opts, "--keep-order-targets")
	}
	if len(config.CategoryOrder) > 0 {
		opts = append(opts, fmt.Sprintf("--category-order %s", strings.Join(config.CategoryOrder, ",")))
	}
	if config.DefaultCategory != "" {
		opts = append(opts, fmt.Sprintf("--default-category %s", config.DefaultCategory))
	}
	if len(config.IncludeTargets) > 0 {
		for _, target := range config.IncludeTargets {
			opts = append(opts, fmt.Sprintf("--include-target %s", target))
		}
	}
	if config.IncludeAllPhony {
		opts = append(opts, "--include-all-phony")
	}

	return strings.Join(opts, " ")
}

// buildRegenerateFlags builds the flag string for the regeneration comment.
func buildRegenerateFlags(config *GeneratorConfig) string {
	var flags []string

	if config.Version != "" {
		flags = append(flags, fmt.Sprintf("--version %s", config.Version))
	}

	// Add same flags as MAKE_HELP_OPTS
	opts := buildMakeHelpOpts(config)
	if opts != "" {
		// Split and add individual flags for better readability
		optParts := strings.Fields(opts)
		flags = append(flags, optParts...)
	}

	if len(flags) == 0 {
		return ""
	}
	return " " + strings.Join(flags, " ")
}

// generateHelpTarget creates help target content with flag pass-through.
// DEPRECATED: This is a compatibility wrapper for add.go which will be refactored in Stage 5.
// The generated target invokes make-help with all relevant configuration flags.
func generateHelpTarget(config *Config) string {
	// Convert old Config to new GeneratorConfig
	genConfig := &GeneratorConfig{
		KeepOrderCategories: config.KeepOrderCategories,
		KeepOrderTargets:    config.KeepOrderTargets,
		CategoryOrder:       config.CategoryOrder,
		DefaultCategory:     config.DefaultCategory,
	}

	// For now, don't generate help-<target> entries since we don't have
	// the documented targets list. Stage 5 will fix this.
	return GenerateHelpFile(genConfig, []string{})
}
