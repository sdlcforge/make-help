# Refactor Plan: Static Help Generation

## Overview

Transform `make-help` from a dynamic help viewer (that generates targets which call `make-help` at runtime) to a static help generator (that embeds formatted help text directly in generated Makefile targets).

## Current vs New Behavior

| Aspect | Current | New |
|--------|---------|-----|
| Default `make-help` | Shows help dynamically | Generates static help file |
| `--create-help-target` | Generates file that calls `make-help` | Removed (now default) |
| `--show-help` | N/A | Shows help dynamically (old default) |
| `--target` | Shows detailed help for one target | Only valid with `--show-help` |
| `--version` | Pins go install version | Removed |
| `--remove-help-target` | Removes help artifacts | Renamed to `--remove-help` |
| Generated file | Contains `go install` + binary invocations | Contains static `@echo` statements with help text |
| Regeneration | Manual | Auto via Makefile dependency on source files |

## CLI Flag Changes

### Remove
- `--create-help-target` (generating is now the default behavior)
- `--version` (no longer installing go binary)

### Rename
- `--remove-help-target` → `--remove-help`

### Add
- `--show-help` - Display help dynamically to stdout (old default behavior)

### Modify
- `--target` - Only valid when combined with `--show-help`

### Unchanged
- `--makefile-path`
- `--help-file-rel-path`
- `--dry-run`
- `--default-category`
- `--keep-order-categories`
- `--keep-order-targets`
- `--category-order`
- `--include-target`
- `--include-all-phony`
- `--no-color` / `--color`
- `--verbose`

## Generated File Format

### Current Format (dynamic)
```makefile
# Generated by make-help. DO NOT EDIT.
MAKE_HELP_DIR := $(dir $(lastword $(MAKEFILE_LIST)))
GOBIN ?= $(MAKE_HELP_DIR).bin
MAKE_HELP_BIN := $(GOBIN)/make-help
MAKE_HELP_OPTS := --makefile-path $(MAKE_HELP_DIR)Makefile
MAKE_HELP_CMD := $(MAKE_HELP_BIN) $(MAKE_HELP_OPTS)

$(MAKE_HELP_BIN):
	GOBIN=$(abspath $(GOBIN)) go install github.com/sdlcforge/make-help/cmd/make-help@latest

.PHONY: help
help: $(MAKE_HELP_BIN)
	@$(MAKE_HELP_CMD)

.PHONY: help-build
help-build: $(MAKE_HELP_BIN)
	@$(MAKE_HELP_CMD) --target build
```

### New Format (static)
```makefile
# Generated by make-help. DO NOT EDIT.
# Regenerate with: make-help

MAKE_HELP_DIR := $(dir $(lastword $(MAKEFILE_LIST)))
MAKE_HELP_MAKEFILES := $(MAKE_HELP_DIR)Makefile $(MAKE_HELP_DIR)make/build.mk $(MAKE_HELP_DIR)make/test.mk

.PHONY: help
## Displays help for available targets.
help: $(MAKE_HELP_DIR)help.mk
	@echo "Usage: make [<target>...] [<ENV_VAR>=<value>...]"
	@echo ""
	@echo "Targets:"
	@echo ""
	@echo "\033[1mBuild:\033[0m"
	@echo "  - \033[36mbuild\033[0m: Build the application"
	@echo "  - \033[36mtest\033[0m: Run all tests"

.PHONY: help-build
help-build: $(MAKE_HELP_DIR)help.mk
	@echo "\033[36mTarget: build\033[0m"
	@echo ""
	@echo "\033[33mDocumentation:\033[0m"
	@echo "  Build the application."
	@echo "  This compiles all Go source files."
	@echo ""
	@echo "Source: Makefile:15"

.PHONY: help-test
help-test: $(MAKE_HELP_DIR)help.mk
	@echo "\033[36mTarget: test\033[0m"
	@echo ""
	@echo "\033[33mDocumentation:\033[0m"
	@echo "  Run all tests."
	@echo ""
	@echo "Source: Makefile:22"

# Auto-regenerate help when source Makefiles change
$(MAKE_HELP_DIR)help.mk: $(MAKE_HELP_MAKEFILES)
	@make-help --makefile-path $(MAKE_HELP_DIR)Makefile || \
	 npx make-help --makefile-path $(MAKE_HELP_DIR)Makefile || \
	 echo "make-help not found; install with 'go install github.com/sdlcforge/make-help/cmd/make-help@latest' or 'npm install -g make-help'"
```

## Implementation Tasks

### Phase 1: CLI Flag Changes

#### 1.1 Update Config struct
**File:** `internal/cli/config.go`

- Remove `Version` field
- Remove `CreateHelpTarget` field
- Add `ShowHelp` field
- Rename concept: generation is default, `ShowHelp` triggers dynamic display

#### 1.2 Update flag registration
**File:** `internal/cli/root.go`

- Remove `--create-help-target` flag
- Remove `--version` flag
- Rename `--remove-help-target` to `--remove-help`
- Add `--show-help` flag
- Update `--target` validation: only valid with `--show-help`
- Update `--dry-run` validation: only valid when generating (default mode), not with `--show-help`

#### 1.3 Update command routing
**File:** `internal/cli/root.go`

- Default (no mode flags): run generation
- `--show-help`: run dynamic help display
- `--show-help --target X`: run detailed help for target X
- `--remove-help`: run removal
- `--dry-run`: show what would be generated

### Phase 2: Renderer Updates

#### 2.1 Add echo-friendly rendering
**File:** `internal/format/renderer.go`

- Add `RenderForMakefile(model) string` method that returns help text suitable for embedding in `@echo` statements
- Handle special characters that need escaping in Makefile/shell context (quotes, $, etc.)
- Add `RenderDetailedForMakefile(target) string` for individual target help

#### 2.2 Update color handling
**File:** `internal/format/renderer.go`

- Colors should be embedded as literal ANSI codes (e.g., `\033[36m`) in generated files
- When `--no-color` is used during generation, omit ANSI codes entirely

### Phase 3: Generator Rewrite

#### 3.1 Update GeneratorConfig
**File:** `internal/target/generator.go`

- Remove `Version` field
- Add `UseColor` field
- Add `Makefiles` field (list of discovered Makefiles for dependency tracking)
- Add `HelpModel` field (the built model to render)

#### 3.2 Rewrite GenerateHelpFile
**File:** `internal/target/generator.go`

- Generate static help content using renderer
- Generate `help` target with embedded summary help
- Generate `help-<target>` targets with embedded detailed help
- Generate auto-regeneration target with Makefile dependencies
- Generate regeneration recipe with fallback chain: `make-help` → `npx make-help` → error message

#### 3.3 Helper functions
**File:** `internal/target/generator.go`

- `escapeForEcho(s string) string` - Escape special chars for shell echo
- `generateRegenerationTarget(makefiles []string) string` - Build the dependency target

### Phase 4: Orchestration Updates

#### 4.1 Update create_help_target.go → generate_help.go
**File:** `internal/cli/create_help_target.go` → rename to `internal/cli/generate_help.go`

- Rename `runCreateHelpTarget` to `runGenerateHelp`
- Pass `UseColor` to generator
- Pass discovered `Makefiles` list to generator
- Pass built `HelpModel` to generator
- Update dry-run output to show new format

#### 4.2 Update help.go
**File:** `internal/cli/help.go`

- `runHelp` becomes `runShowHelp` (called when `--show-help` is used)
- `runDetailedHelp` becomes `runShowDetailedHelp` (called when `--show-help --target X`)
- These remain largely unchanged (dynamic display to stdout)

#### 4.3 Update remove logic
**File:** `internal/cli/remove_help_target.go` → rename to `internal/cli/remove_help.go`

- Rename function to `runRemoveHelp`
- Behavior unchanged (remove help file and include directive)

### Phase 5: File Location Changes

#### 5.1 Always create separate file
**File:** `internal/target/add.go`

- Remove the "append to main Makefile" path
- Always create a separate `.mk` file
- If no `include make/*.mk` pattern found, create `help.mk` in same directory and add include directive

### Phase 6: Test Updates

#### 6.1 Update CLI tests
**File:** `internal/cli/root_test.go`

- Update flag validation tests for new flag names
- Add tests for `--show-help` flag
- Update `--target` validation tests (now requires `--show-help`)
- Update `--dry-run` validation tests

#### 6.2 Update generator tests
**File:** `internal/target/generator_test.go`

- Test static help content generation
- Test color embedding
- Test special character escaping
- Test regeneration target generation

#### 6.3 Update integration tests
**File:** `internal/cli/create_help_target_test.go` → `generate_help_test.go`

- Test default behavior generates help file
- Test `--dry-run` shows correct static content
- Test `--show-help` displays dynamic help
- Test `--show-help --target X` displays detailed help

#### 6.4 Update fixture files
**Directory:** `test/fixtures/`

- Update expected output files for new format
- Add fixtures for static help content

### Phase 7: Documentation Updates

#### 7.1 Update README.md
- Update CLI flags table
- Update usage examples
- Update "How it works" section

#### 7.2 Update architecture docs
- `docs/architecture/components.md` - Update CLI and generator sections
- `docs/architecture/program-flow.md` - Update flow diagrams
- `docs/architecture/design-decisions.md` - Add decision about static vs dynamic

#### 7.3 Update CLAUDE.md
- Update flag references
- Update common tasks

#### 7.4 Update examples
**Directory:** `examples/`

- Regenerate all `help.mk` files with new static format

## File Changes Summary

### New Files
- None

### Renamed Files
- `internal/cli/create_help_target.go` → `internal/cli/generate_help.go`
- `internal/cli/create_help_target_test.go` → `internal/cli/generate_help_test.go`
- `internal/cli/remove_help_target.go` → `internal/cli/remove_help.go`

### Modified Files
- `internal/cli/config.go`
- `internal/cli/root.go`
- `internal/cli/root_test.go`
- `internal/cli/help.go`
- `internal/target/generator.go`
- `internal/target/generator_test.go`
- `internal/target/add.go`
- `internal/format/renderer.go`
- `internal/format/renderer_test.go`
- `internal/errors/errors.go` (update error messages)
- `README.md`
- `docs/architecture/components.md`
- `docs/architecture/program-flow.md`
- `docs/architecture/design-decisions.md`
- `.claude/CLAUDE.md`
- `examples/*/help.mk`
- `test/fixtures/expected/*.txt`

### Deleted Files
- None

## Migration Notes

### For Users
- `make-help` now generates help by default (was `make-help --create-help-target`)
- To view help dynamically: `make-help --show-help`
- `--remove-help-target` is now `--remove-help`
- `--version` flag is removed (no longer needed)
- `--target` now requires `--show-help`

### Breaking Changes
1. Default behavior changed from display to generation
2. `--create-help-target` removed
3. `--version` removed
4. `--remove-help-target` renamed to `--remove-help`
5. `--target` requires `--show-help`
6. Generated help files have completely different format (static vs dynamic)

## Testing Strategy

1. **Unit tests first**: Update/add tests for each component as it's modified
2. **Integration tests**: Verify end-to-end behavior
3. **Manual testing**: Test with example Makefiles
4. **Regenerate examples**: Ensure all examples work with new format

## Rollout Order

1. Phase 1: CLI flag changes (breaking change to interface)
2. Phase 2: Renderer updates (internal, non-breaking)
3. Phase 3: Generator rewrite (internal, non-breaking)
4. Phase 4: Orchestration updates (connects everything)
5. Phase 5: File location changes (simplification)
6. Phase 6: Test updates (ensure quality)
7. Phase 7: Documentation updates (user-facing)

Each phase should result in passing tests before moving to the next.
